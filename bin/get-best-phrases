#!/usr/bin/env python
import sys
import os
import os.path
import re
import yaml
from elasticsearch import Elasticsearch

configFilePath = os.path.abspath(sys.argv[1])

config = None

def __getDataDir(configFilePath, config):
  dataDir = os.path.abspath(os.path.join(os.path.dirname(configFilePath), config["output_path"]))
  if not os.path.exists(dataDir):
    os.makedirs(dataDir)
  return dataDir

if not os.path.exists(configFilePath):
  print "Config file does not exist"
  sys.exit(1)
try:
  dataStream = open(configFilePath, "r")
  config = yaml.load(dataStream)
except:
  error = sys.exc_info()
  print "Failed to load configuration from file", error
  sys.exit(1)

esClient = Elasticsearch(config["elasticsearch"]["host"] + ":" + str(config["elasticsearch"]["port"]))
processorIndex = config["processor"]["index"]
processorType = config["processor"]["type"]
processorPhraseType = config["processor"]["type"] + "__phrase"

phrasesCount = esClient.count(index=processorIndex, doc_type=processorPhraseType, body={"query":{"terms":{"class_type":["1"]}}})
print phrasesCount
size = phrasesCount["count"]
phrases = esClient.search(index=processorIndex, doc_type=processorPhraseType, body={"query":{"terms":{"is_training":["1"]}}, "sort":[{"prob":{"order":"desc"}}]}, size=size)
phrases = phrases["hits"]["hits"]

print len(phrases)
